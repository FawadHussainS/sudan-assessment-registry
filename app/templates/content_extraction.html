{% extends "base.html" %}

{% block title %}Content Extraction - AI Needs Analysis{% endblock %}

{% block page_title %}Content Extraction{% endblock %}
{% block page_subtitle %}Extract and analyze document content for AI processing{% endblock %}

{% block extra_css %}
<style>
    .extraction-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .processing-card {
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 25px;
        margin-bottom: 25px;
        border-left: 4px solid #007bff;
    }
    
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .dashboard-card {
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 25px;
        margin-bottom: 25px;
        border-left: 4px solid #007bff;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-top: 15px;
    }

    .stat-item {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #2563eb;
    }

    .stat-label {
        font-size: 0.9em;
        color: #6b7280;
        margin-top: 5px;
    }
    
    .processing-status {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 500;
    }
    
    .status-pending { background-color: #ffeaa7; color: #2d3436; }
    .status-processing { background-color: #74b9ff; color: white; }
    .status-completed { background-color: #00b894; color: white; }
    .status-error { background-color: #e17055; color: white; }
    
    .file-selection {
        border: 2px dashed #ddd;
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        margin-bottom: 20px;
        transition: border-color 0.3s;
    }
    
    .file-selection:hover {
        border-color: #007bff;
    }
    
    .file-selection.dragover {
        border-color: #28a745;
        background-color: #f8fff9;
    }
    
    .processing-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 25px;
    }
    
    .option-group {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }
    
    .feature-list {
        display: grid;
        gap: 15px;
    }

    .feature-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .feature-icon {
        font-size: 1.5em;
        width: 40px;
        text-align: center;
    }

    .feature-info strong {
        display: block;
        margin-bottom: 5px;
        color: #1f2937;
    }

    .feature-info p {
        margin: 0;
        color: #6b7280;
        font-size: 0.9em;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
    }

    .file-info strong {
        color: #1f2937;
    }
    
    .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    
    .coming-soon-badge {
        background: #ffeaa7;
        color: #2d3436;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8em;
        margin-left: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="extraction-container">
    <div class="dashboard-grid">
        <!-- Statistics Overview -->
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>üìä Extraction Statistics</h3>
                <span id="overall-status" class="processing-status status-pending">Ready</span>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number">{{ stats.total_documents }}</div>
                    <div class="stat-label">Total Documents</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ stats.extracted }}</div>
                    <div class="stat-label">Extracted</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ stats.pending }}</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ stats.failed }}</div>
                    <div class="stat-label">Failed</div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-card">
            <h3>üöÄ Quick Actions</h3>
            <div class="feature-list">
                <div class="feature-item">
                    <span class="feature-icon">üìÑ</span>
                    <div class="feature-info">
                        <strong>Upload Documents <span class="coming-soon-badge">Coming Soon</span></strong>
                        <p>Upload new documents for processing</p>
                    </div>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">‚ö°</span>
                    <div class="feature-info">
                        <strong>Batch Processing <span class="coming-soon-badge">Coming Soon</span></strong>
                        <p>Process multiple documents at once</p>
                    </div>
                </div>
                <div class="feature-item">
                    <span class="feature-icon">üîç</span>
                    <div class="feature-info">
                        <strong>Semantic Search <span class="coming-soon-badge">Coming Soon</span></strong>
                        <p>Search through extracted content</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Queue -->
    <div class="dashboard-card">
        <h3>üîÑ Processing Queue</h3>
        <p class="text-muted">Documents available for content extraction</p>
        
        {% if downloads %}
        <div class="table-container">
            <table class="data-table table table-striped">
                <thead>
                    <tr>
                        <th>Document</th>
                        <th>Assessment ID</th>
                        <th>File Size</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for download in downloads %}
                    <tr>
                        <td>
                            <div class="file-info">
                                <strong>{{ download.filename or 'Unknown File' }}</strong>
                                <br>
                                <small class="text-muted">Downloaded: {{ download.download_date or 'N/A' }}</small>
                            </div>
                        </td>
                        <td>{{ download.assessment_id or 'N/A' }}</td>
                        <td>
                            {% if download.file_size %}
                                {% if download.file_size < 1024 %}
                                    {{ download.file_size }} B
                                {% elif download.file_size < 1048576 %}
                                    {{ "%.1f"|format(download.file_size / 1024) }} KB
                                {% else %}
                                    {{ "%.1f"|format(download.file_size / 1048576) }} MB
                                {% endif %}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            <span class="processing-status status-pending">
                                Ready for Extraction
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="processDocument({{ download.id }})">
                                üöÄ Extract Content
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <p>No documents available for extraction.</p>
            <a href="{{ url_for('download_rw.download_documents') }}" class="btn btn-primary">
                üì• Download Documents First
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Future Features Preview -->
    <div class="dashboard-card">
        <h3>üîÆ AI-Powered Features (Coming Soon)</h3>
        <div class="feature-list">
            <div class="feature-item">
                <span class="feature-icon">üîç</span>
                <div class="feature-info">
                    <strong>PDF Text Extraction</strong>
                    <p>Extract text content from PDF documents using pdfplumber</p>
                </div>
            </div>
            <div class="feature-item">
                <span class="feature-icon">üß†</span>
                <div class="feature-info">
                    <strong>Vector Embeddings</strong>
                    <p>Generate embeddings using sentence-transformers for semantic search</p>
                </div>
            </div>
            <div class="feature-item">
                <span class="feature-icon">üè∑Ô∏è</span>
                <div class="feature-info">
                    <strong>Admin Geo-tagging</strong>
                    <p>Extract administrative districts and locations using spaCy NLP</p>
                </div>
            </div>
            <div class="feature-item">
                <span class="feature-icon">üìä</span>
                <div class="feature-info">
                    <strong>Content Analysis</strong>
                    <p>Topic modeling, sentiment analysis, and readability scoring</p>
                </div>
            </div>
            <div class="feature-item">
                <span class="feature-icon">üîó</span>
                <div class="feature-info">
                    <strong>FAISS Vector Database</strong>
                    <p>High-performance similarity search and clustering</p>
                </div>
            </div>
            <div class="feature-item">
                <span class="feature-icon">üåê</span>
                <div class="feature-info">
                    <strong>Multi-language Support</strong>
                    <p>Process documents in multiple languages with automatic detection</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Development Status -->
    <div class="dashboard-card">
        <h3>üõ†Ô∏è Development Status</h3>
        <div class="alert alert-info">
            <h5><i class="fas fa-info-circle"></i> Current Phase: Foundation Setup</h5>
            <p class="mb-2">The Content Extraction system is currently in development. Here's what's ready:</p>
            <ul class="mb-2">
                <li>‚úÖ Database schema for content metadata</li>
                <li>‚úÖ Document processing pipeline structure</li>
                <li>‚úÖ Vector database utilities (FAISS)</li>
                <li>‚úÖ Admin geo-tagging utilities</li>
                <li>‚è≥ PDF/DOCX content extractors</li>
                <li>‚è≥ Embedding generation pipeline</li>
                <li>‚è≥ Real-time processing interface</li>
            </ul>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary" onclick="showDevelopmentPlan()">
                    üìã View Development Plan
                </button>
                <a href="{{ url_for('download_rw.download_documents') }}" class="btn btn-primary">
                    üì• Download Sample Documents
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Development Plan Modal -->
<div class="modal fade" id="developmentPlanModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üöÄ Content Extraction Development Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="timeline">
                    <div class="timeline-item completed">
                        <h6>‚úÖ Phase 1: Foundation (Completed)</h6>
                        <ul>
                            <li>Database schema design</li>
                            <li>Blueprint structure</li>
                            <li>Utility modules</li>
                        </ul>
                    </div>
                    <div class="timeline-item current">
                        <h6>üîÑ Phase 2: Core Processing (In Progress)</h6>
                        <ul>
                            <li>PDF text extraction (pdfplumber)</li>
                            <li>DOCX content extraction (python-docx)</li>
                            <li>Text cleaning and preprocessing</li>
                            <li>Content chunking strategies</li>
                        </ul>
                    </div>
                    <div class="timeline-item">
                        <h6>‚è≥ Phase 3: AI Integration (Next)</h6>
                        <ul>
                            <li>Sentence transformer embeddings</li>
                            <li>FAISS vector database integration</li>
                            <li>Named entity recognition (spaCy)</li>
                            <li>Administrative geo-tagging</li>
                        </ul>
                    </div>
                    <div class="timeline-item">
                        <h6>üîÆ Phase 4: Advanced Features (Future)</h6>
                        <ul>
                            <li>Real-time semantic search</li>
                            <li>Document similarity clustering</li>
                            <li>Topic modeling and analysis</li>
                            <li>Multi-language support</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Update stats periodically
    setInterval(updateStats, 30000); // Every 30 seconds
    
    function updateStats() {
        $.get('/content_extraction/api/stats')
            .done(function(data) {
                $('.stat-number').each(function(index) {
                    const statNames = ['total_documents', 'extracted', 'pending', 'failed'];
                    $(this).text(data[statNames[index]] || 0);
                });
            })
            .fail(function() {
                console.log('Failed to update stats');
            });
    }
    
    function processDocument(documentId) {
        if (confirm('Start content extraction for this document? (Feature coming soon)')) {
            $('#overall-status').removeClass().addClass('processing-status status-processing').text('Processing');
            
            fetch(`/content_extraction/process_document/${documentId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $('#overall-status').removeClass().addClass('processing-status status-completed').text('Ready');
                    showAlert('info', data.message);
                } else {
                    $('#overall-status').removeClass().addClass('processing-status status-error').text('Error');
                    showAlert('danger', 'Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                $('#overall-status').removeClass().addClass('processing-status status-error').text('Error');
                showAlert('danger', 'Error processing document');
            });
        }
    }
    
    function showDevelopmentPlan() {
        $('#developmentPlanModal').modal('show');
    }
    
    function showAlert(type, message) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        $('.extraction-container').prepend(alertHtml);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            $('.alert').alert('close');
        }, 5000);
    }
    
    // Make functions globally available
    window.processDocument = processDocument;
    window.showDevelopmentPlan = showDevelopmentPlan;
});
</script>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    margin-bottom: 30px;
    padding-left: 30px;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -22px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #dee2e6;
    border: 2px solid #fff;
}

.timeline-item.completed::before {
    background: #28a745;
}

.timeline-item.current::before {
    background: #007bff;
}

.timeline-item h6 {
    margin-bottom: 10px;
    color: #495057;
}

.timeline-item ul {
    margin-bottom: 0;
    padding-left: 20px;
}

.timeline-item li {
    margin-bottom: 5px;
    color: #6c757d;
}
</style>
{% endblock %}
