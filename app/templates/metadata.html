{% extends "base.html" %}

{% block title %}View Records - Sudan Assessment Registry{% endblock %}

{% block extra_head %}
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .stats-card {
            border-left: 4px solid var(--ocha-blue);
        }
        .badge-country {
            background-color: var(--ocha-blue);
            color: white;
        }
        .badge-format {
            background-color: #28a745;
            color: white;
        }
        .badge-source {
            background-color: #6c757d;
            color: white;
        }
        .text-truncate-custom {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .search-box {
            background-color: var(--ocha-light-blue);
            border: 1px solid var(--ocha-blue);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .btn-sm {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            line-height: 1.2;
        }
        
        .btn-sm i {
            font-size: 0.75rem;
        }
        
        .d-flex {
            display: flex;
        }
        
        .gap-1 {
            gap: 0.25rem;
        }
        
        .gap-2 {
            gap: 0.5rem;
        }
        
        .align-items-center {
            align-items: center;
        }
        
        .justify-content-end {
            justify-content: flex-end;
        }
        
        .justify-content-between {
            justify-content: space-between;
        }
        
        .mb-3 {
            margin-bottom: 1rem;
        }
        
        .mt-3 {
            margin-top: 1rem;
        }
        
        .mb-4 {
            margin-bottom: 1.5rem;
        }
        
        .text-end {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-muted {
            color: #6c757d;
        }
        
        /* Ensure buttons have consistent height */
        .btn-outline-primary, .btn-outline-info, .btn-outline-success, .btn-primary {
            min-height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Add these badge styles */
        .recent-meta-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin: 2px;
            background: var(--ocha-light-blue);
            color: var(--ocha-dark-blue);
            border: 1px solid rgba(0, 106, 182, 0.2);
        }
        
        .recent-meta-badge:hover {
            background: var(--ocha-blue);
            color: white;
            transform: translateY(-1px);
        }
        
        .recent-meta-badge i {
            font-size: 10px;
            opacity: 0.8;
        }
        
        .recent-meta-value {
            font-weight: 500;
        }
        
        .recent-meta-badge.country {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #bbdefb;
        }
        
        .recent-meta-badge.organization {
            background: #f3e5f5;
            color: #7b1fa2;
            border-color: #e1bee7;
        }
        
        .recent-meta-badge.format {
            background: #e8f5e8;
            color: #2e7d32;
            border-color: #c8e6c9;
        }
        
        .recent-meta-badge.date {
            background: #fff3e0;
            color: #ef6c00;
            border-color: #ffcc02;
        }
        
        /* Table responsive improvements */
        .table-responsive {
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .table {
            margin-bottom: 0;
        }
        
        .table thead th {
            background: var(--ocha-blue);
            color: white;
            border-bottom: none;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 123, 255, 0.05);
        }
        
        .table-hover tbody tr:hover {
            background-color: var(--ocha-light-blue);
        }
        
        /* Modal improvements */
        .modal-header {
            background: var(--ocha-blue);
            color: white;
        }
        
        .modal-header .btn-close {
            filter: invert(1);
        }
        
        /* Alert styling */
        .alert-info {
            background-color: var(--ocha-light-blue);
            border-color: var(--ocha-blue);
            color: var(--ocha-dark-blue);
        }
        
        /* Form controls */
        .form-control, .form-select {
            border: 1px solid var(--ocha-border);
            border-radius: 4px;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--ocha-blue);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        /* Grid system classes */
        .row {
            display: flex;
            flex-wrap: wrap;
            margin-left: -0.5rem;
            margin-right: -0.5rem;
        }
        
        .g-2 > * {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        
        .col-md-1 { flex: 0 0 8.333333%; max-width: 8.333333%; }
        .col-md-2 { flex: 0 0 16.666667%; max-width: 16.666667%; }
        .col-md-3 { flex: 0 0 25%; max-width: 25%; }
        .col-md-5 { flex: 0 0 41.666667%; max-width: 41.666667%; }
        .col-md-7 { flex: 0 0 58.333333%; max-width: 58.333333%; }
        .col { flex: 1 0 0%; }
        
        @media (max-width: 768px) {
            .col-md-1, .col-md-2, .col-md-3, .col-md-5, .col-md-7 {
                flex: 0 0 100%;
                max-width: 100%;
                margin-bottom: 0.5rem;
            }
        }

        .recent-meta-badge-group {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            gap: 0 4px;
            min-width: 0;
            max-width: 220px;
        }

        /* Enhanced filter styling */
        .form-label.small {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px !important;
        }

        .form-select-sm, .form-control-sm {
            font-size: 12px;
            padding: 4px 8px;
            height: auto;
            min-height: 32px;
        }

        /* Multi-select source styling */
        #sourceFilter {
            font-size: 10px !important;
            line-height: 1.1 !important;
            padding: 2px 4px !important;
            height: 72px !important;
            overflow-y: auto;
        }

        #sourceFilter option {
            padding: 2px 4px;
            font-size: 10px;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        #sourceFilter option:hover,
        #sourceFilter option:focus {
            background-color: var(--ocha-light-blue);
            color: var(--ocha-dark-blue);
        }

        #sourceFilter option:checked {
            background-color: var(--ocha-blue) !important;
            color: white !important;
            font-weight: 500;
        }

        /* Search input enhancement */
        #searchInput {
            border: 2px solid var(--ocha-border);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #searchInput:focus {
            border-color: var(--ocha-blue);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.15), 0 2px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        /* Filter area improvements */
        .search-box {
            background: linear-gradient(135deg, var(--ocha-light-blue) 0%, rgba(255,255,255,0.8) 100%);
            border: 1px solid rgba(0, 106, 182, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        /* Clear button styling - fixed size and positioning */
        .clear-btn {
            width: 32px !important;
            height: 32px !important;
            min-width: 32px !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-shrink: 0 !important;
            margin-top: 0 !important;
        }

        .clear-btn i {
            font-size: 12px !important;
        }

        /* Date range inputs styling */
        #dateFromFilter, #dateToFilter {
            font-size: 10px !important;
            padding: 2px 4px !important;
            height: 28px !important;
            min-width: 0 !important;
            flex: 1 !important;
        }

        /* Gap for date inputs */
        .d-flex.gap-1 {
            gap: 4px !important;
        }

        /* Better spacing for filter controls */
        .col-md-1 .btn,
        .col-md-2 .form-select,
        .col-md-2 .form-control,
        .col-md-3 .form-select,
        .col-md-3 .d-flex {
            width: 100%;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .col-md-1, .col-md-2, .col-md-3 {
                flex: 0 0 100%;
                max-width: 100%;
                margin-bottom: 0.5rem;
            }
            
            #sourceFilter {
                height: 60px !important;
                size: 2;
            }
            
            .search-box {
                padding: 15px;
            }
            
            .clear-btn {
                width: 60px !important;
                height: 32px !important;
                margin: 0 auto !important;
            }
            
            /* Ensure date inputs don't get squished on mobile */
            #dateFromFilter, #dateToFilter {
                min-width: 120px !important;
            }
        }

        #sourceFilter option[value="all"] {
            background-color: #f8f9fa !important;
            font-weight: bold !important;
            border-bottom: 1px solid #dee2e6 !important;
            color: #495057 !important;
        }

        #sourceFilter option[value="all"]:checked {
            background-color: var(--ocha-blue) !important;
            color: white !important;
            font-weight: bold !important;
        }

        /* Bulk selection styles */
        .bulk-actions {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .bulk-actions.show {
            display: block;
        }

        .bulk-actions .selected-count {
            font-weight: bold;
            color: var(--ocha-blue);
        }

        /* Checkbox styling */
        .record-checkbox {
            transform: scale(1.2);
            margin-right: 8px;
        }

        #selectAllCheckbox {
            transform: scale(1.2);
        }

        /* Dynamic button states */
        .download-btn {
            position: relative;
            transition: all 0.3s ease;
        }

        .download-btn.filtered {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #000;
        }

        .download-btn.selected {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        .download-btn .badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <a href="{{ url_for('main.index') }}">Home</a> / <a href="{{ url_for('metadata.view_metadata') }}">View Records</a>
</div>
{% endblock %}

{% block page_title %}Assessment Records{% endblock %}
{% block page_subtitle %}View and manage extracted humanitarian assessment data{% endblock %}

{% block content %}
    <!-- Quick Actions -->
    <div class="d-flex justify-content-end align-items-center mb-3 gap-2">
        <div>
            <small class="text-muted" id="recordCountLabel">
                ({{ data|length }} records)
            </small>
        </div>
        <button id="csvDownloadBtn" class="btn btn-outline-primary btn-sm download-btn" style="min-width: 150px;" onclick="downloadData('csv')">
            <i class="fas fa-download"></i> <span class="btn-text">Download CSV</span>
            <span class="badge" id="csvBadge" style="display: none;"></span>
        </button>
        <button id="excelDownloadBtn" class="btn btn-outline-success btn-sm download-btn" style="min-width: 150px;" onclick="downloadData('excel')">
            <i class="fas fa-file-excel"></i> <span class="btn-text">Download Excel</span>
            <span class="badge" id="excelBadge" style="display: none;"></span>
        </button>
        <a href="{{ url_for('main.index') }}" class="btn btn-primary btn-sm" style="min-width: 150px;">
            <i class="fas fa-plus"></i> Extract New Records
        </a>
    </div>

    <!-- Bulk Actions Panel -->
    <div class="bulk-actions" id="bulkActions">
        <div class="row align-items-center">
            <div class="col-md-4">
                <span class="selected-count" id="selectedCount">0 records selected</span>
            </div>
            <div class="col-md-8 text-end">
                <button class="btn btn-outline-primary btn-sm" onclick="downloadSelected('csv')">
                    <i class="fas fa-download"></i> Download Selected (CSV)
                </button>
                <button class="btn btn-outline-success btn-sm" onclick="downloadSelected('excel')">
                    <i class="fas fa-file-excel"></i> Download Selected (Excel)
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                    <i class="fas fa-times"></i> Clear Selection
                </button>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="search-box mb-4">
        <!-- Main search row -->
        <div class="row g-2 mb-3">
            <div class="col-md-12">
                <input type="text" id="searchInput" class="form-control" placeholder="ðŸ” Search titles, countries, sources..." style="font-size: 16px; height: 42px;">
            </div>
        </div>
        
        <!-- Filter controls row -->
        <div class="row g-2 align-items-start">
            <div class="col-md-2">
                <label class="form-label small text-muted mb-1">Country</label>
                <select id="countryFilter" class="form-select form-select-sm">
                    <option value="">All Countries</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted mb-1">Format</label>
                <select id="formatFilter" class="form-select form-select-sm">
                    <option value="">All Formats</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted mb-1">Sources (Multi-select)</label>
                <select id="sourceFilter" class="form-select form-select-sm" multiple size="3" 
                        style="font-size: 11px; line-height: 1.2;">
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted mb-1">Theme</label>
                <select id="themeFilter" class="form-select form-select-sm">
                    <option value="">All Themes</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted mb-1">Date Range</label>
                <div class="d-flex gap-1">
                    <input type="date" id="dateFromFilter" class="form-control form-control-sm" placeholder="From" title="From Date">
                    <input type="date" id="dateToFilter" class="form-control form-control-sm" placeholder="To" title="To Date">
                </div>
            </div>
            <div class="col-md-1 d-flex align-items-end justify-content-center">
                <button type="button" class="btn btn-outline-secondary btn-sm clear-btn" onclick="clearFilters()" title="Clear all filters">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    {% if data %}
    <div class="table-responsive">
        <table class="table table-striped table-hover" id="dataTable">
            <thead>
                <tr>
                    <th width="3%">
                        <input type="checkbox" id="selectAllCheckbox" title="Select All">
                    </th>
                    <th width="4%">#</th>
                    <th width="28%">Title</th>
                    <th width="12%">Country</th>
                    <th width="15%">Source</th>
                    <th width="10%">Format</th>
                    <th width="10%">Date</th>
                    <th width="8%">Theme</th>
                    <th width="10%">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for record in data %}
                <tr data-record-id="{{ record.id }}">
                    <td>
                        <input type="checkbox" class="record-checkbox" value="{{ record.id }}" title="Select this record">
                    </td>
                    <td>{{ loop.index }}</td>
                    <td>
                        <div class="text-truncate-custom" title="{{ record.title }}">
                            <strong>{{ record.title }}</strong>
                        </div>
                        {% if record.body %}
                        <small class="text-muted">
                            {{ record.body[:250] }}{% if record.body|length > 250 %}...{% endif %}
                        </small>
                        {% endif %}
                    </td>
                    <td>
                        <div class="recent-meta-badge country" title="{{ record.primary_country or record.country }}">
                            <i class="fas fa-map-marker-alt"></i>
                            <span class="recent-meta-value">
                                {{ record.primary_country if record.primary_country and record.primary_country.strip() else record.country if record.country and record.country.strip() else 'Multiple Countries' }}
                            </span>
                        </div>
                        {% if record.country and record.primary_country and record.country != record.primary_country %}
                            <br>
                            <span class="recent-meta-badge country" style="background:#e3eaf6;color:#2c5282;font-weight:400;">
                                + {{ record.country[:30] }}{% if record.country|length > 30 %}...{% endif %}
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="recent-meta-badge-group" title="{{ record.source }}">
                            {% if record.source %}
                                {% for src in record.source.split(',') %}
                                    <span class="recent-meta-badge organization" style="margin-right: 4px; margin-bottom: 4px;">
                                        <i class="fas fa-users"></i>
                                        <span class="recent-meta-value">
                                            {{ src.strip()[:30] }}{% if src.strip()|length > 30 %}...{% endif %}
                                        </span>
                                    </span>
                                {% endfor %}
                            {% else %}
                                <span class="recent-meta-badge organization">
                                    <i class="fas fa-users"></i>
                                    <span class="recent-meta-value">Unknown Source</span>
                                </span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="recent-meta-badge format" title="{{ record.format }}">
                            <i class="fas fa-file-alt"></i>
                            <span class="recent-meta-value">
                                {{ record.format if record.format and record.format.strip() else 'Assessment' }}
                            </span>
                        </div>
                    </td>
                    <td>
                        <div class="recent-meta-badge date" title="{{ record.date_created }}">
                            <i class="fas fa-calendar"></i>
                            <span class="recent-meta-value">
                                {{ record.date_created[:10] if record.date_created else 'No Date' }}
                            </span>
                        </div>
                    </td>
                    <td>
                        {% if record.theme %}
                            {% for theme in record.theme.split(',') %}
                                <span class="recent-meta-badge format" style="background:#f7c59f;color:#7a4f01;">
                                    <i class="fas fa-tag"></i>
                                    <span class="recent-meta-value">
                                        {{ theme.strip()[:20] }}{% if theme.strip()|length > 20 %}...{% endif %}
                                    </span>
                                </span>
                            {% endfor %}
                        {% else %}
                            <span class="recent-meta-badge format" style="background:#eee;color:#888;">
                                <i class="fas fa-tag"></i>
                                <span class="recent-meta-value">N/A</span>
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="d-flex gap-1 align-items-center">
                            {% if record.url %}
                            <a href="{{ record.url }}" target="_blank" class="btn btn-outline-primary btn-sm" title="View Original">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            {% endif %}
                            <a href="{{ url_for('manage.get_record_details', record_id=record.id) }}" class="btn btn-outline-info btn-sm" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination Info -->
    <div class="d-flex justify-content-between align-items-center mt-3">
        <small class="text-muted">
            Showing <span id="recordCount">{{ data|length }}</span> records
        </small>
        <small class="text-muted">
            Last updated: <span id="lastUpdated"></span>
        </small>
    </div>
    {% else %}
    <!-- No Data State -->
    <div class="alert alert-info text-center mt-4">
        <i class="fas fa-info-circle fa-2x mb-3"></i>
        <h5>No Assessment Records Found</h5>
        <p class="mb-3">You haven't extracted any assessment data yet.</p>
        <a href="{{ url_for('main.index') }}" class="btn btn-primary">
            <i class="fas fa-download"></i> Extract Your First Assessments
        </a>
    </div>
    {% endif %}

    <!-- Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-info-circle"></i> Assessment Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add a small delay to ensure all elements are fully rendered
        setTimeout(function() {
            populateFilters();
            setupSearch();
            setLastUpdated();
            setupBulkSelection();
            updateDownloadButtons();
        }, 100);
    });

    function setLastUpdated() {
        const now = new Date();
        const formatted = now.getFullYear() + '-' +
                         String(now.getMonth() + 1).padStart(2, '0') + '-' +
                         String(now.getDate()).padStart(2, '0') + ' ' +
                         String(now.getHours()).padStart(2, '0') + ':' +
                         String(now.getMinutes()).padStart(2, '0');

        const lastUpdatedElement = document.getElementById('lastUpdated');
        if (lastUpdatedElement) {
            lastUpdatedElement.textContent = formatted;
        }
    }

    function populateFilters() {
        const table = document.getElementById('dataTable');
        if (!table) {
            console.log('Table not found');
            return;
        }

        const tbody = table.getElementsByTagName('tbody')[0];
        if (!tbody) {
            console.log('Table body not found');
            return;
        }

        const rows = tbody.getElementsByTagName('tr');
        console.log('Found rows:', rows.length);

        const countries = new Set();
        const formats = new Set();
        const sources = new Set();
        const themes = new Set();

        for (let row of rows) {
            // Updated cell indices to account for checkbox column
            // Country
            const countryCell = row.cells[3]; // was cells[2]
            if (countryCell) {
                const countryBadge = countryCell.querySelector('.recent-meta-badge.country .recent-meta-value');
                if (countryBadge && countryBadge.textContent.trim() !== 'Multiple Countries') {
                    countries.add(countryBadge.textContent.trim());
                }
            }

            // Source (collect all badges)
            const sourceCell = row.cells[4]; // was cells[3]
            if (sourceCell) {
                const sourceBadges = sourceCell.querySelectorAll('.recent-meta-badge.organization .recent-meta-value');
                console.log('Source badges found in row:', sourceBadges.length);
                sourceBadges.forEach(badge => {
                    const val = badge.textContent.trim();
                    console.log('Source value:', val);
                    if (val && val !== 'Unknown Source') {
                        sources.add(val);
                    }
                });
            }

            // Format
            const formatCell = row.cells[5]; // was cells[4]
            if (formatCell) {
                const formatBadge = formatCell.querySelector('.recent-meta-badge.format .recent-meta-value');
                if (formatBadge) {
                    formats.add(formatBadge.textContent.trim());
                }
            }

            // Theme
            const themeCell = row.cells[7]; // was cells[6]
            if (themeCell) {
                const themeBadges = themeCell.querySelectorAll('.recent-meta-badge .recent-meta-value');
                themeBadges.forEach(badge => {
                    if (badge.textContent.trim() !== 'N/A') {
                        themes.add(badge.textContent.trim());
                    }
                });
            }
        }

        console.log('Sources collected:', Array.from(sources));
        console.log('Countries collected:', Array.from(countries));
        console.log('Formats collected:', Array.from(formats));
        console.log('Themes collected:', Array.from(themes));

        // Populate filters
        const setOptions = (id, values, label) => {
            const select = document.getElementById(id);
            if (!select) return;
            
            select.innerHTML = ''; // Clear previous options
            
            // Add "All" option for all filters including multi-select
            if (id === 'sourceFilter') {
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'All Sources';
                allOption.style.fontWeight = 'bold';
                allOption.style.backgroundColor = '#f8f9fa';
                select.appendChild(allOption);
            } else {
                select.innerHTML = `<option value="">All ${label}</option>`;
            }
            
            Array.from(values).sort().forEach(val => {
                const option = document.createElement('option');
                option.value = val;
                // Truncate source names for better display in multi-select
                if (id === 'sourceFilter') {
                    option.textContent = val.length > 25 ? val.substring(0, 25) + '...' : val;
                    option.title = val; // Full name on hover
                } else {
                    option.textContent = val;
                }
                select.appendChild(option);
            });
        };

        setOptions('countryFilter', countries, 'Countries');
        setOptions('formatFilter', formats, 'Formats');
        setOptions('sourceFilter', sources, 'Sources');
        setOptions('themeFilter', themes, 'Themes');
    }

    function setupSearch() {
        const searchInput = document.getElementById('searchInput');
        const countryFilter = document.getElementById('countryFilter');
        const formatFilter = document.getElementById('formatFilter');
        const sourceFilter = document.getElementById('sourceFilter');
        const themeFilter = document.getElementById('themeFilter');
        const dateFromFilter = document.getElementById('dateFromFilter');
        const dateToFilter = document.getElementById('dateToFilter');

        if (searchInput) searchInput.addEventListener('input', filterTable);
        if (countryFilter) countryFilter.addEventListener('change', filterTable);
        if (formatFilter) formatFilter.addEventListener('change', filterTable);
        if (sourceFilter) sourceFilter.addEventListener('change', filterTable);
        if (themeFilter) themeFilter.addEventListener('change', filterTable);
        if (dateFromFilter) dateFromFilter.addEventListener('change', filterTable);
        if (dateToFilter) dateToFilter.addEventListener('change', filterTable);
    }

    function filterTable() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const countryFilter = document.getElementById('countryFilter').value;
        const formatFilter = document.getElementById('formatFilter').value;
        const sourceFilterSelect = document.getElementById('sourceFilter');
        const sourceFilters = Array.from(sourceFilterSelect.selectedOptions).map(opt => opt.value).filter(Boolean);
        const themeFilter = document.getElementById('themeFilter').value;
        const dateFromFilter = document.getElementById('dateFromFilter').value;
        const dateToFilter = document.getElementById('dateToFilter').value;

        const table = document.getElementById('dataTable');
        if (!table) return;

        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        let visibleCount = 0;

        for (let row of rows) {
            // Updated cell indices to account for checkbox column
            const title = row.cells[2].textContent.toLowerCase(); // was cells[1]
            const country = row.cells[3].textContent; // was cells[2]
            const sourceCell = row.cells[4]; // was cells[3]
            const sourceBadges = sourceCell.querySelectorAll('.recent-meta-badge.organization .recent-meta-value');
            const sources = Array.from(sourceBadges).map(badge => badge.textContent.trim());
            const format = row.cells[5].textContent; // was cells[4]
            const dateCell = row.cells[6]; // was cells[5]
            const dateBadge = dateCell.querySelector('.recent-meta-badge.date .recent-meta-value');
            const dateText = dateBadge ? dateBadge.textContent.trim() : '';
            const theme = row.cells[7].textContent; // was cells[6]

            const matchesSearch = title.includes(searchTerm) ||
                                  country.toLowerCase().includes(searchTerm) ||
                                  sources.some(src => src.toLowerCase().includes(searchTerm));

            const matchesCountry = !countryFilter || country.includes(countryFilter);
            const matchesFormat = !formatFilter || format.includes(formatFilter);
            
            // Updated source filtering to handle "All Sources" option
            const matchesSource = sourceFilters.length === 0 || 
                                 sourceFilters.includes('all') || 
                                 sources.some(src => sourceFilters.includes(src));
            
            const matchesTheme = !themeFilter || theme.includes(themeFilter);
            
            // Date range filtering
            let matchesDateRange = true;
            if (dateFromFilter || dateToFilter) {
                if (dateText && dateText !== 'No Date') {
                    const recordDate = new Date(dateText);
                    if (dateFromFilter) {
                        const fromDate = new Date(dateFromFilter);
                        if (recordDate < fromDate) matchesDateRange = false;
                    }
                    if (dateToFilter) {
                        const toDate = new Date(dateToFilter);
                        if (recordDate > toDate) matchesDateRange = false;
                    }
                } else {
                    matchesDateRange = false; // No date in record, exclude from date filtering
                }
            }

            if (matchesSearch && matchesCountry && matchesFormat && matchesSource && matchesTheme && matchesDateRange) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }

        const recordCount = document.getElementById('recordCount');
        if (recordCount) {
            recordCount.textContent = visibleCount;
        }

        const recordCountLabel = document.getElementById('recordCountLabel');
        if (recordCountLabel) {
            recordCountLabel.textContent = `(${visibleCount} records)`;
        }

        // Update download buttons when filtering changes
        updateDownloadButtons();
    }

    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('countryFilter').value = '';
        document.getElementById('formatFilter').value = '';
        
        // Clear multi-select and select "All Sources" by default
        const sourceFilter = document.getElementById('sourceFilter');
        sourceFilter.selectedIndex = -1; // Clear all selections
        const allSourcesOption = sourceFilter.querySelector('option[value="all"]');
        if (allSourcesOption) {
            allSourcesOption.selected = true;
        }
        
        document.getElementById('themeFilter').value = '';
        document.getElementById('dateFromFilter').value = '';
        document.getElementById('dateToFilter').value = '';
        filterTable();
        updateDownloadButtons();
    }

    function viewDetails(recordId) {
        fetch(`{{ url_for('manage.get_record_details', record_id=0) }}`.replace('0', recordId))
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const modalBody = document.getElementById('modalBody');
                modalBody.innerHTML = `
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-file-alt"></i> Title</h6>
                                <p>${data.title || 'N/A'}</p>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-map-marker-alt"></i> Country</h6>
                                <p>${data.country || 'N/A'}</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-users"></i> Source</h6>
                                <p>${data.source || 'N/A'}</p>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-calendar"></i> Date</h6>
                                <p>${data.date_created || 'N/A'}</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <h6><i class="fas fa-align-left"></i> Description</h6>
                                <p>${data.body || 'No description available'}</p>
                            </div>
                        </div>
                        ${data.url ? `
                        <div class="row">
                            <div class="col-12">
                                <h6><i class="fas fa-link"></i> Original URL</h6>
                                <p><a href="${data.url}" target="_blank">${data.url}</a></p>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error fetching details:', error);
                alert('Error loading record details');
            });
    }

    // Bulk selection functionality
    let selectedRecords = new Set();
    let isFiltered = false;

    function setupBulkSelection() {
        // Setup select all checkbox
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.record-checkbox');
                const visibleCheckboxes = Array.from(checkboxes).filter(cb => {
                    const row = cb.closest('tr');
                    return row && row.style.display !== 'none';
                });

                visibleCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                    if (this.checked) {
                        selectedRecords.add(checkbox.value);
                    } else {
                        selectedRecords.delete(checkbox.value);
                    }
                });
                updateBulkActions();
                updateDownloadButtons();
            });
        }

        // Setup individual checkboxes
        const recordCheckboxes = document.querySelectorAll('.record-checkbox');
        recordCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    selectedRecords.add(this.value);
                } else {
                    selectedRecords.delete(this.value);
                }
                updateSelectAllState();
                updateBulkActions();
                updateDownloadButtons();
            });
        });
    }

    function updateSelectAllState() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (!selectAllCheckbox) return;

        const visibleCheckboxes = Array.from(document.querySelectorAll('.record-checkbox')).filter(cb => {
            const row = cb.closest('tr');
            return row && row.style.display !== 'none';
        });

        const checkedVisibleCount = visibleCheckboxes.filter(cb => cb.checked).length;
        
        if (checkedVisibleCount === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (checkedVisibleCount === visibleCheckboxes.length) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else {
            selectAllCheckbox.indeterminate = true;
            selectAllCheckbox.checked = false;
        }
    }

    function updateBulkActions() {
        const bulkActions = document.getElementById('bulkActions');
        const selectedCount = document.getElementById('selectedCount');
        
        if (selectedRecords.size > 0) {
            bulkActions.classList.add('show');
            selectedCount.textContent = `${selectedRecords.size} record${selectedRecords.size === 1 ? '' : 's'} selected`;
        } else {
            bulkActions.classList.remove('show');
        }
    }

    function clearSelection() {
        selectedRecords.clear();
        const checkboxes = document.querySelectorAll('.record-checkbox, #selectAllCheckbox');
        checkboxes.forEach(cb => cb.checked = false);
        updateBulkActions();
        updateDownloadButtons();
    }

    function updateDownloadButtons() {
        const csvBtn = document.getElementById('csvDownloadBtn');
        const excelBtn = document.getElementById('excelDownloadBtn');
        const csvBadge = document.getElementById('csvBadge');
        const excelBadge = document.getElementById('excelBadge');

        // Reset button states
        csvBtn.className = 'btn btn-outline-primary btn-sm download-btn';
        excelBtn.className = 'btn btn-outline-success btn-sm download-btn';
        csvBadge.style.display = 'none';
        excelBadge.style.display = 'none';

        // Check if filtering is active
        const searchTerm = document.getElementById('searchInput').value;
        const countryFilter = document.getElementById('countryFilter').value;
        const formatFilter = document.getElementById('formatFilter').value;
        const sourceFilterSelect = document.getElementById('sourceFilter');
        const sourceFilters = Array.from(sourceFilterSelect.selectedOptions).map(opt => opt.value).filter(val => val !== 'all');
        const themeFilter = document.getElementById('themeFilter').value;
        const dateFromFilter = document.getElementById('dateFromFilter').value;
        const dateToFilter = document.getElementById('dateToFilter').value;

        isFiltered = searchTerm || countryFilter || formatFilter || sourceFilters.length > 0 || themeFilter || dateFromFilter || dateToFilter;

        if (selectedRecords.size > 0) {
            // Selection mode
            csvBtn.classList.add('selected');
            excelBtn.classList.add('selected');
            csvBtn.querySelector('.btn-text').textContent = `Download Selected CSV`;
            excelBtn.querySelector('.btn-text').textContent = `Download Selected Excel`;
            csvBadge.textContent = selectedRecords.size;
            excelBadge.textContent = selectedRecords.size;
            csvBadge.style.display = 'block';
            excelBadge.style.display = 'block';
        } else if (isFiltered) {
            // Filtered mode
            csvBtn.classList.add('filtered');
            excelBtn.classList.add('filtered');
            csvBtn.querySelector('.btn-text').textContent = 'Download Filtered CSV';
            excelBtn.querySelector('.btn-text').textContent = 'Download Filtered Excel';
            
            // Count visible records
            const visibleCount = document.querySelectorAll('#dataTable tbody tr[style=""], #dataTable tbody tr:not([style*="none"])').length;
            csvBadge.textContent = visibleCount;
            excelBadge.textContent = visibleCount;
            csvBadge.style.display = 'block';
            excelBadge.style.display = 'block';
        } else {
            // Normal mode
            csvBtn.querySelector('.btn-text').textContent = 'Download CSV';
            excelBtn.querySelector('.btn-text').textContent = 'Download Excel';
        }
    }

    function downloadData(format) {
        if (selectedRecords.size > 0) {
            downloadSelected(format);
        } else if (isFiltered) {
            downloadFiltered(format);
        } else {
            // Download all data
            window.location.href = `{{ url_for('metadata.download_metadata') }}?format=${format}`;
        }
    }

    function downloadSelected(format) {
        if (selectedRecords.size === 0) {
            alert('Please select records to download');
            return;
        }

        const selectedIds = Array.from(selectedRecords).join(',');
        window.location.href = `{{ url_for('metadata.download_metadata') }}?format=${format}&selected_ids=${selectedIds}`;
    }

    function downloadFiltered(format) {
        // Get current filter state
        const filters = {
            search: document.getElementById('searchInput').value,
            country: document.getElementById('countryFilter').value,
            format: document.getElementById('formatFilter').value,
            sources: Array.from(document.getElementById('sourceFilter').selectedOptions).map(opt => opt.value).filter(Boolean),
            theme: document.getElementById('themeFilter').value,
            dateFrom: document.getElementById('dateFromFilter').value,
            dateTo: document.getElementById('dateToFilter').value
        };

        // Send filter data to server
        fetch('{{ url_for("metadata.get_filtered_data") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(filters)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error getting filtered data: ' + data.error);
                return;
            }
            
            if (data.record_ids.length === 0) {
                alert('No records match your filters');
                return;
            }

            const selectedIds = data.record_ids.join(',');
            window.location.href = `{{ url_for('metadata.download_metadata') }}?format=${format}&selected_ids=${selectedIds}&filtered=true`;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error downloading filtered data');
        });
    }

    // Update the existing filterTable function to call updateDownloadButtons
    const originalFilterTable = filterTable;
    filterTable = function() {
        originalFilterTable();
        updateDownloadButtons();
        
        // Update checkbox states after filtering
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (selectAllCheckbox) {
            updateSelectAllState();
        }
    };
</script>
{% endblock %}