{% extends "base.html" %}

{% block title %}View Records - Sudan Assessment Registry{% endblock %}

{% block extra_head %}
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .stats-card {
            border-left: 4px solid var(--ocha-blue);
        }
        .badge-country {
            background-color: var(--ocha-blue);
            color: white;
        }
        .badge-format {
            background-color: #28a745;
            color: white;
        }
        .badge-source {
            background-color: #6c757d;
            color: white;
        }
        .text-truncate-custom {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .search-box {
            background-color: var(--ocha-light-blue);
            border: 1px solid var(--ocha-blue);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .btn-sm {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            line-height: 1.2;
        }
        
        .btn-sm i {
            font-size: 0.75rem;
        }
        
        .d-flex {
            display: flex;
        }
        
        .gap-1 {
            gap: 0.25rem;
        }
        
        .align-items-center {
            align-items: center;
        }
        
        /* Ensure buttons have consistent height */
        .btn-outline-primary, .btn-outline-info {
            min-height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Add these badge styles */
        .recent-meta-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin: 2px;
            background: var(--ocha-light-blue);
            color: var(--ocha-dark-blue);
            border: 1px solid rgba(0, 106, 182, 0.2);
        }
        
        .recent-meta-badge:hover {
            background: var(--ocha-blue);
            color: white;
            transform: translateY(-1px);
        }
        
        .recent-meta-badge i {
            font-size: 10px;
            opacity: 0.8;
        }
        
        .recent-meta-value {
            font-weight: 500;
        }
        
        .recent-meta-badge.country {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #bbdefb;
        }
        
        .recent-meta-badge.organization {
            background: #f3e5f5;
            color: #7b1fa2;
            border-color: #e1bee7;
        }
        
        .recent-meta-badge.format {
            background: #e8f5e8;
            color: #2e7d32;
            border-color: #c8e6c9;
        }
        
        .recent-meta-badge.date {
            background: #fff3e0;
            color: #ef6c00;
            border-color: #ffcc02;
        }
    </style>
{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
    <a href="{{ url_for('index') }}">Home</a> / <a href="{{ url_for('view_metadata') }}">View Records</a>
</div>
{% endblock %}

{% block page_title %}Assessment Records{% endblock %}
{% block page_subtitle %}View and manage extracted humanitarian assessment data{% endblock %}

{% block content %}
    <!-- Quick Actions -->
    <div class="d-flex justify-content-end align-items-center mb-3 gap-2">
        <div>
            <small class="text-muted" id="recordCountLabel">
                ({{ data|length }} records)
            </small>
        </div>
        <a href="/download/metadata?format=csv" class="btn btn-outline-primary btn-sm" style="min-width: 150px;">
            <i class="fas fa-download"></i> Download CSV
        </a>
        <a href="/download/metadata?format=excel" class="btn btn-outline-success btn-sm" style="min-width: 150px;">
            <i class="fas fa-file-excel"></i> Download Excel
        </a>
        <a href="/" class="btn btn-primary btn-sm" style="min-width: 150px;">
            <i class="fas fa-plus"></i> Extract New Records
        </a>
    </div>

    <!-- Search and Filter -->
    <div class="search-box mb-4">
        <div class="row g-2">
            <div class="col-md-3">
                <input type="text" id="searchInput" class="form-control" placeholder="Search titles, countries, sources...">
            </div>
            <div class="col-md-2">
                <select id="countryFilter" class="form-select">
                    <option value="">All Countries</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="formatFilter" class="form-select">
                    <option value="">All Formats</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="sourceFilter" class="form-select">
                    <option value="">All Sources</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="themeFilter" class="form-select">
                    <option value="">All Themes</option>
                </select>
            </div>
            <div class="col-md-1">
                <input type="date" id="dateFilter" class="form-control" placeholder="Date">
            </div>
        </div>
        <div class="row mt-2">
            <div class="col text-end">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    {% if data %}
    <div class="table-responsive">
        <table class="table table-striped table-hover" id="dataTable">
            <thead>
                <tr>
                    <th width="5%">#</th>
                    <th width="30%">Title</th>
                    <th width="12%">Country</th>
                    <th width="15%">Source</th>
                    <th width="10%">Format</th>
                    <th width="10%">Date</th>
                    <th width="8%">Theme</th>
                    <th width="10%">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for record in data %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>
                        <div class="text-truncate-custom" title="{{ record.title }}">
                            <strong>{{ record.title }}</strong>
                        </div>
                        {% if record.body %}
                        <small class="text-muted">
                            {{ record.body[:250] }}{% if record.body|length > 250 %}...{% endif %}
                        </small>
                        {% endif %}
                    </td>
                    <td>
                        <div class="recent-meta-badge country" title="{{ record.primary_country or record.country }}">
                <i class="fas fa-map-marker-alt"></i>
                <span class="recent-meta-value">
                    {{ record.primary_country if record.primary_country and record.primary_country.strip() else record.country if record.country and record.country.strip() else 'Multiple Countries' }}
                </span>
            </div>
            {% if record.country and record.primary_country and record.country != record.primary_country %}
                <br>
                <span class="recent-meta-badge country" style="background:#e3eaf6;color:#2c5282;font-weight:400;">
                    + {{ record.country[:30] }}{% if record.country|length > 30 %}...{% endif %}
                </span>
            {% endif %}
                    </td>
                    <td>
                        <div class="recent-meta-badge organization" title="{{ record.source }}">
                <i class="fas fa-users"></i>
                <span class="recent-meta-value">
                    {{ record.source if record.source and record.source.strip() else 'Unknown Source' }}
                </span>
            </div>
                    </td>
                    <td>
                        <div class="recent-meta-badge format" title="{{ record.format }}">
                <i class="fas fa-file-alt"></i>
                <span class="recent-meta-value">
                    {{ record.format if record.format and record.format.strip() else 'Assessment' }}
                </span>
            </div>
                    </td>
                    <td>
                        <div class="recent-meta-badge date" title="{{ record.date_created }}">
                <i class="fas fa-calendar"></i>
                <span class="recent-meta-value">
                    {{ record.date_created[:10] if record.date_created else 'No Date' }}
                </span>
            </div>
                    </td>
                    <td>
                        {% if record.theme %}
                {% for theme in record.theme.split(',') %}
                    <span class="recent-meta-badge format" style="background:#f7c59f;color:#7a4f01;">
                        <i class="fas fa-tag"></i>
                        <span class="recent-meta-value">
                            {{ theme.strip()[:20] }}{% if theme.strip()|length > 20 %}...{% endif %}
                        </span>
                    </span>
                {% endfor %}
            {% else %}
                <span class="recent-meta-badge format" style="background:#eee;color:#888;">
                    <i class="fas fa-tag"></i>
                    <span class="recent-meta-value">N/A</span>
                </span>
            {% endif %}
                    </td>
                    <td>
                        <div class="d-flex gap-1 align-items-center">
        {% if record.url %}
        <a href="{{ record.url }}" target="_blank" class="btn btn-outline-primary btn-sm" title="View Original">
            <i class="fas fa-external-link-alt"></i>
        </a>
        {% endif %}
        <button class="btn btn-outline-info btn-sm" onclick="viewDetails({{ record.id }})" title="View Details">
            <i class="fas fa-eye"></i>
        </button>
    </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination Info -->
    <div class="d-flex justify-content-between align-items-center mt-3">
        <small class="text-muted">
            Showing <span id="recordCount">{{ data|length }}</span> records
        </small>
        <small class="text-muted">
            Last updated: <span id="lastUpdated"></span>
        </small>
    </div>
    {% else %}
    <!-- No Data State -->
    <div class="alert alert-info text-center mt-4">
        <i class="fas fa-info-circle fa-2x mb-3"></i>
        <h5>No Assessment Records Found</h5>
        <p class="mb-3">You haven't extracted any assessment data yet.</p>
        <a href="/" class="btn btn-primary">
            <i class="fas fa-download"></i> Extract Your First Assessments
        </a>
    </div>
    {% endif %}

    <!-- Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-info-circle"></i> Assessment Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        populateFilters();
        setupSearch();
        setLastUpdated();
    });

    function setLastUpdated() {
        const now = new Date();
        const formatted = now.getFullYear() + '-' +
                         String(now.getMonth() + 1).padStart(2, '0') + '-' +
                         String(now.getDate()).padStart(2, '0') + ' ' +
                         String(now.getHours()).padStart(2, '0') + ':' +
                         String(now.getMinutes()).padStart(2, '0');

        const lastUpdatedElement = document.getElementById('lastUpdated');
        if (lastUpdatedElement) {
            lastUpdatedElement.textContent = formatted;
        }
    }

    function populateFilters() {
        const table = document.getElementById('dataTable');
        if (!table) return;

        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        const countries = new Set();
        const formats = new Set();
        const sources = new Set();
        const themes = new Set();

        for (let row of rows) {
            // Country
            const countryCell = row.cells[2];
            if (countryCell) {
                const countryBadge = countryCell.querySelector('.recent-meta-badge.country .recent-meta-value');
                if (countryBadge && countryBadge.textContent.trim() !== 'Multiple Countries') {
                    countries.add(countryBadge.textContent.trim());
                }
            }
            // Source
            const sourceCell = row.cells[3];
            if (sourceCell) {
                const sourceBadge = sourceCell.querySelector('.recent-meta-badge.organization .recent-meta-value');
                if (sourceBadge && sourceBadge.textContent.trim() !== 'Unknown Source') {
                    sources.add(sourceBadge.textContent.trim());
                }
            }
            // Format
            const formatCell = row.cells[4];
            if (formatCell) {
                const formatBadge = formatCell.querySelector('.recent-meta-badge.format .recent-meta-value');
                if (formatBadge) {
                    formats.add(formatBadge.textContent.trim());
                }
            }
            // Theme
            const themeCell = row.cells[6];
            if (themeCell) {
                const themeBadges = themeCell.querySelectorAll('.recent-meta-badge.format .recent-meta-value');
                themeBadges.forEach(badge => {
                    if (badge.textContent.trim() !== 'N/A') {
                        themes.add(badge.textContent.trim());
                    }
                });
            }
        }

        // Populate filters
        const setOptions = (id, values, label) => {
            const select = document.getElementById(id);
            if (!select) return;
            select.innerHTML = `<option value="">All ${label}</option>`;
            Array.from(values).sort().forEach(val => {
                const option = document.createElement('option');
                option.value = val;
                option.textContent = val;
                select.appendChild(option);
            });
        };
        setOptions('countryFilter', countries, 'Countries');
        setOptions('formatFilter', formats, 'Formats');
        setOptions('sourceFilter', sources, 'Sources');
        setOptions('themeFilter', themes, 'Themes');
    }

    function setupSearch() {
        ['searchInput', 'countryFilter', 'formatFilter', 'sourceFilter', 'themeFilter', 'dateFilter'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', filterTable);
            if (el && el.tagName === 'SELECT') el.addEventListener('change', filterTable);
        });
    }

    function filterTable() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const countryFilter = document.getElementById('countryFilter').value;
        const formatFilter = document.getElementById('formatFilter').value;
        const sourceFilter = document.getElementById('sourceFilter').value;
        const themeFilter = document.getElementById('themeFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;

        const table = document.getElementById('dataTable');
        if (!table) return;

        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        let visibleCount = 0;

        for (let row of rows) {
            const title = row.cells[1].textContent.toLowerCase();
            const country = row.cells[2].textContent;
            const source = row.cells[3].textContent;
            const format = row.cells[4].textContent;
            const date = row.cells[5].textContent;
            const theme = row.cells[6].textContent;

            const matchesSearch = title.includes(searchTerm) ||
                                  country.toLowerCase().includes(searchTerm) ||
                                  source.toLowerCase().includes(searchTerm);

            const matchesCountry = !countryFilter || country.includes(countryFilter);
            const matchesFormat = !formatFilter || format.includes(formatFilter);
            const matchesSource = !sourceFilter || source.includes(sourceFilter);
            const matchesTheme = !themeFilter || theme.includes(themeFilter);
            const matchesDate = !dateFilter || date.includes(dateFilter);

            if (matchesSearch && matchesCountry && matchesFormat && matchesSource && matchesTheme && matchesDate) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }

        // Update record count label
        const recordCountLabel = document.getElementById('recordCountLabel');
        if (recordCountLabel) {
            recordCountLabel.textContent = `(${visibleCount} records)`;
        }
    }

    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('countryFilter').value = '';
        document.getElementById('formatFilter').value = '';
        document.getElementById('sourceFilter').value = '';
        document.getElementById('themeFilter').value = '';
        document.getElementById('dateFilter').value = '';
        filterTable();
    }

    function viewDetails(recordId) {
        fetch(`/manage/record/${recordId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const record = data.record;
                    const modalBody = document.getElementById('modalBody');

                    // Helper for file links (assuming file_info is a string or array)
                    function renderFiles(fileInfo, fileUrl) {
                        if (!fileInfo && !fileUrl) return '';
                        let html = `<div class="mt-2"><strong>Files:</strong><br>`;
                        if (fileInfo) {
                            // Try to extract filename and mime type
                            const fileMatch = fileInfo.match(/File:\s*(.+)\s+\((.+)\)/i);
                            if (fileMatch) {
                                const filename = fileMatch[1];
                                const mimetype = fileMatch[2];
                                if (fileUrl) {
                                    html += `<small><a href="${fileUrl}" target="_blank" rel="noopener">${filename}</a> <span class="text-muted">(${mimetype})</span></small>`;
                                } else {
                                    html += `<small>${filename} <span class="text-muted">(${mimetype})</span></small>`;
                                }
                            } else {
                                html += `<small>${fileInfo}</small>`;
                            }
                        }
                        // If file_info doesn't have a URL but fileUrl is present
                        if (!fileInfo && fileUrl) {
                            html += `<small><a href="${fileUrl}" target="_blank" rel="noopener">${fileUrl}</a></small>`;
                        }
                        html += `</div>`;
                        return html;
                    }

                    modalBody.innerHTML = `
                        <div class="container-fluid">
                            <div class="row mb-2">
                                <div class="col-md-7">
                                    <h5 class="mb-1">${record.title || 'N/A'}</h5>
                                    <div class="mb-2">
                                        <span class="recent-meta-badge country" title="${record.primary_country || ''}">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <span class="recent-meta-value">${record.primary_country || 'N/A'}</span>
                                        </span>
                                        <span class="recent-meta-badge organization" title="${record.source || ''}">
                                            <i class="fas fa-users"></i>
                                            <span class="recent-meta-value">${record.source || 'N/A'}</span>
                                        </span>
                                        <span class="recent-meta-badge format" title="${record.format || ''}">
                                            <i class="fas fa-file-alt"></i>
                                            <span class="recent-meta-value">${record.format || 'N/A'}</span>
                                        </span>
                                        <span class="recent-meta-badge date" title="${record.date_created || ''}">
                                            <i class="fas fa-calendar"></i>
                                            <span class="recent-meta-value">${record.date_created ? record.date_created.substring(0, 10) : 'N/A'}</span>
                                        </span>
                                        ${record.theme ? record.theme.split(',').map(theme => `
                                            <span class="recent-meta-badge format" style="background:#f7c59f;color:#7a4f01;">
                                                <i class="fas fa-tag"></i>
                                                <span class="recent-meta-value">${theme.trim().substring(0, 20)}${theme.trim().length > 20 ? '...' : ''}</span>
                                            </span>
                                        `).join('') : ''}
                                    </div>
                                    <div class="mb-2">
                                        <strong>Status:</strong> ${record.status || 'N/A'}<br>
                                        <strong>Language:</strong> ${record.language || 'N/A'}<br>
                                        <strong>Disaster:</strong> ${record.disaster || 'N/A'}
                                    </div>
                                    <div class="mb-2">
                                        <strong>All Countries:</strong> ${record.country || 'N/A'}
                                    </div>
                                    <div class="mb-2">
                                        <strong>Report ID:</strong> ${record.report_id || 'N/A'}
                                    </div>
                                    ${record.url ? `
                                        <div class="mb-2">
                                            <strong>URL:</strong>
                                            <br>
                                            <small>
                                                <a href="${record.url}" target="_blank" rel="noopener" class="ms-1">
                                                    ${record.url}
                                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                            </small>
                                        </div>
                                    ` : ''}
                                    ${renderFiles(record.file_info, record.url)}
                                    ${record.file_urls ? record.file_urls.map((url, i) => renderFiles(record.file_info_list[i], url)).join('') : ''}
                                </div>
                                <div class="col-md-5">
                                    <strong>Summary:</strong>
                                    <div style="max-height: 220px; overflow-y: auto; background: #f8f9fa; border-radius: 6px; padding: 10px; margin-top: 5px;">
                                        ${record.body ? record.body.replace(/\n/g, '<br>') : '<span class="text-muted">No summary available</span>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
                    modal.show();
                } else {
                    alert('Error loading record details: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading record details');
            });
    }
</script>
{% endblock %}